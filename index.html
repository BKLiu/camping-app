<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>露營小助手 - 多人同步版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8faf8;
        }
        .tab-active {
            border-bottom: 3px solid #059669;
            color: #059669;
        }
        .expense-card {
            transition: transform 0.2s;
        }
        .expense-card:hover {
            transform: translateY(-2px);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-stone-800">

    <!-- Header -->
    <header class="bg-emerald-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="layout-dashboard"></i> 露營小助手
            </h1>
            <div class="flex items-center gap-2">
                <button onclick="toggleSyncModal()" id="sync-status-btn" class="text-xs bg-emerald-800 hover:bg-emerald-900 px-3 py-1 rounded-full flex items-center gap-1 transition">
                    <span id="sync-dot" class="w-2 h-2 bg-stone-400 rounded-full"></span>
                    <span id="sync-text">連線準備中...</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white border-b border-stone-200 sticky top-[60px] z-40">
        <div class="max-w-4xl mx-auto flex overflow-x-auto no-scrollbar">
            <button onclick="switchTab('dashboard-tab')" id="btn-dashboard-tab" class="flex-1 min-w-[80px] py-3 text-center font-medium tab-active transition-all">總覽</button>
            <button onclick="switchTab('map-tab')" id="btn-map-tab" class="flex-1 min-w-[80px] py-3 text-center font-medium text-stone-500 transition-all">行程</button>
            <button onclick="switchTab('expense-tab')" id="btn-expense-tab" class="flex-1 min-w-[80px] py-3 text-center font-medium text-stone-500 transition-all">分帳</button>
            <button onclick="switchTab('members-tab')" id="btn-members-tab" class="flex-1 min-w-[80px] py-3 text-center font-medium text-stone-500 transition-all">成員</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 pb-24">
        
        <!-- Tab: Dashboard -->
        <section id="dashboard-tab" class="space-y-4">
            <div class="bg-gradient-to-br from-emerald-600 to-teal-700 rounded-2xl p-6 text-white shadow-lg">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-emerald-100 text-sm">當前露營行程</p>
                        <h2 id="dash-camp-name" class="text-2xl font-bold">尚未設定目的地</h2>
                    </div>
                    <i data-lucide="tent" class="w-10 h-10 opacity-50"></i>
                </div>
                <div id="dash-location-btn-container" class="hidden flex gap-2">
                    <button onclick="openGoogleMaps()" class="bg-white/20 hover:bg-white/30 transition px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                        <i data-lucide="map"></i> 開啟地圖
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100">
                    <p class="text-xs text-stone-500 uppercase">總花費</p>
                    <p id="dash-total-expense" class="text-xl font-bold text-emerald-700">$0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100">
                    <p class="text-xs text-stone-500 uppercase">人均費用</p>
                    <p id="dash-avg-expense" class="text-xl font-bold text-blue-600">$0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100">
                    <p class="text-xs text-stone-500 uppercase">營位費總計</p>
                    <p id="dash-camp-fee-total" class="text-xl font-bold text-amber-600">$0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100">
                    <p class="text-xs text-stone-500 uppercase">參與成員</p>
                    <p id="dash-member-count" class="text-xl font-bold text-stone-700">0 人</p>
                </div>
            </div>

            <!-- Trip Summary Quick View -->
            <div id="dash-trip-details-card" class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100 hidden">
                <h3 class="font-bold text-sm text-stone-600 mb-3 flex items-center gap-2">
                    <i data-lucide="clipboard-list" class="w-4 h-4"></i> 營地細節
                </h3>
                <div id="dash-camp-details-content" class="text-sm text-stone-500 space-y-2">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-stone-100 overflow-hidden">
                <div class="bg-stone-50 px-4 py-3 border-b border-stone-100 flex justify-between items-center">
                    <h3 class="font-bold flex items-center gap-2"><i data-lucide="coins" class="w-4 h-4 text-amber-500"></i> 結算快捷報</h3>
                </div>
                <div id="dash-settlement-list" class="p-4 space-y-3">
                    <p class="text-center text-stone-400 py-4 text-sm italic">尚無分帳建議</p>
                </div>
            </div>
        </section>

        <!-- Tab: Map (Trip Settings) -->
        <section id="map-tab" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                <h3 class="font-bold mb-4 flex items-center gap-2 text-emerald-700">
                    <i data-lucide="map-pin"></i> 營地行程資料
                </h3>
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-stone-600 mb-2">營地名稱</label>
                        <input type="text" id="manual-location" placeholder="例如：武陵農場、那山那谷..." class="w-full border border-stone-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-stone-600 mb-2">營位費 (總計)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-stone-400">$</span>
                                <input type="number" id="camp-fee-input" placeholder="0" class="w-full border border-stone-300 rounded-lg pl-8 pr-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-stone-600 mb-2">夜衝費 (總計)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-stone-400">$</span>
                                <input type="number" id="night-fee-input" placeholder="0" class="w-full border border-stone-300 rounded-lg pl-8 pr-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-stone-600 mb-2">營地細節 / 備註</label>
                        <textarea id="camp-details-input" rows="3" placeholder="例如：營位 A1、幾點進場、插座位置..." class="w-full border border-stone-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none"></textarea>
                    </div>

                    <button onclick="saveTripData()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition shadow-md flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i> 儲存行程資料
                    </button>
                    
                    <div id="location-active-ui" class="bg-emerald-50 p-6 rounded-xl border border-emerald-100 hidden text-center">
                        <button onclick="openGoogleMaps()" class="inline-flex items-center gap-2 bg-white border-2 border-emerald-600 text-emerald-700 font-bold px-8 py-3 rounded-full hover:bg-emerald-600 hover:text-white transition">
                            <i data-lucide="external-link" class="w-5 h-5"></i> 在 Google Map 中開啟
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: Expense -->
        <section id="expense-tab" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                <h3 class="font-bold mb-4 flex items-center gap-2 text-emerald-700">
                    <i data-lucide="plus-circle"></i> 新增支出
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="exp-title" placeholder="項目名稱 (如：食材)" class="border border-stone-300 rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-emerald-500">
                        <input type="number" id="exp-amount" placeholder="金額" class="border border-stone-300 rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-stone-500 mb-1">誰付錢？</label>
                            <select id="exp-payer" class="w-full border border-stone-300 rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-emerald-500 italic text-stone-400">
                                <option value="">請先新增成員</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="addExpense()" class="w-full bg-emerald-600 text-white font-bold h-[42px] rounded-lg hover:bg-emerald-700 transition">加入支出</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="expense-list" class="space-y-3"></div>
        </section>

        <!-- Tab: Members -->
        <section id="members-tab" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                <h3 class="font-bold mb-4 flex items-center gap-2 text-emerald-700">
                    <i data-lucide="user-plus"></i> 管理成員
                </h3>
                <div class="flex gap-2">
                    <input type="text" id="member-name" onkeyup="if(event.key==='Enter') addMember()" placeholder="輸入名字..." class="flex-1 border border-stone-300 rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-emerald-500">
                    <button onclick="addMember()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold">新增</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-stone-50 border-b border-stone-100 font-bold text-stone-500">
                        <tr><th class="px-6 py-3">名稱</th><th class="px-6 py-3 text-right">已支付</th><th class="px-6 py-3 text-right">操作</th></tr>
                    </thead>
                    <tbody id="members-list-body"></tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- Sync Modal -->
    <div id="sync-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 space-y-6 shadow-2xl">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="refresh-cw" class="text-emerald-600"></i> 多人連線同步</h2>
                <button onclick="toggleSyncModal()" class="text-stone-400 hover:text-stone-600"><i data-lucide="x"></i></button>
            </div>
            
            <div id="sync-off-ui" class="space-y-4">
                <p class="text-sm text-stone-500 leading-relaxed">開啟同步功能後，資料將存於雲端。你可以分享 ID 給朋友，讓大家即時查看並編輯同一個行程。</p>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="startNewTrip()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition">開啟新行程同步</button>
                    <div class="flex items-center gap-2">
                        <input type="text" id="join-trip-id" placeholder="輸入朋友分享的行程 ID" class="flex-1 border border-stone-300 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-emerald-500">
                        <button onclick="joinExistingTrip()" class="bg-stone-800 text-white px-4 py-2 rounded-xl font-bold hover:bg-stone-900 transition">加入</button>
                    </div>
                </div>
            </div>

            <div id="sync-on-ui" class="hidden space-y-4">
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 text-center">
                    <p class="text-xs text-emerald-600 font-bold uppercase mb-1 tracking-widest">當前行程 ID</p>
                    <div class="flex items-center justify-center gap-2">
                        <code id="current-trip-id-display" class="text-lg font-mono font-bold text-emerald-800">------</code>
                        <button onclick="copyTripID()" class="text-emerald-600 hover:text-emerald-700 p-1"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <button onclick="stopSync()" class="w-full border border-stone-200 text-stone-500 py-2 rounded-xl text-sm hover:bg-stone-50 transition">停止同步並返回單機模式</button>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-stone-800 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 pointer-events-none transition-all z-[100]">
        <span id="message-text"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, updateDoc, deleteDoc, collection, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-camp-app';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = {
            isSyncing: false,
            tripId: localStorage.getItem('active_trip_id') || null,
            user: null,
            members: [],
            expenses: [],
            campName: "",
            campFee: 0,
            nightFee: 0,
            campDetails: ""
        };

        let unsubscribes = [];

        // --- Auth ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                showMessage("身分驗證失敗，僅能使用單機模式");
            }
        };

        const updateSyncUI = (active) => {
            const dot = document.getElementById('sync-dot');
            const txt = document.getElementById('sync-text');
            const offUi = document.getElementById('sync-off-ui');
            const onUi = document.getElementById('sync-on-ui');
            const idDisp = document.getElementById('current-trip-id-display');

            if (dot) dot.className = `w-2 h-2 rounded-full ${active ? 'bg-emerald-400 animate-pulse' : 'bg-stone-400'}`;
            if (txt) txt.innerText = active ? `同步中 (${state.tripId})` : (state.user ? "同步功能就緒" : "身分驗證中...");
            if (offUi) offUi.classList.toggle('hidden', active);
            if (onUi) onUi.classList.toggle('hidden', !active);
            if (active && idDisp) idDisp.innerText = state.tripId;
        };

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user && state.tripId) {
                startRealtimeSync(state.tripId);
            } else {
                loadLocalData();
                updateSyncUI(false);
            }
        });

        // --- Sync Functions ---
        const startRealtimeSync = async (tripId) => {
            if (!tripId || !auth.currentUser) return;
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            state.isSyncing = true;
            state.tripId = tripId;
            localStorage.setItem('active_trip_id', tripId);
            updateSyncUI(true);

            const infoRef = doc(db, 'artifacts', appId, 'public', 'data', 'tripMetadata', tripId);
            unsubscribes.push(onSnapshot(infoRef, (snap) => {
                if (!auth.currentUser) return;
                if (snap.exists()) {
                    const data = snap.data();
                    state.campName = data.campName || "";
                    state.campFee = data.campFee || 0;
                    state.nightFee = data.nightFee || 0;
                    state.campDetails = data.campDetails || "";
                    syncFormFields();
                    renderAll();
                    updateLocationUI();
                }
            }));

            const membersCol = collection(db, 'artifacts', appId, 'public', 'data', tripId + '_members');
            unsubscribes.push(onSnapshot(membersCol, (snap) => {
                if (!auth.currentUser) return;
                state.members = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAll();
            }));

            const expensesCol = collection(db, 'artifacts', appId, 'public', 'data', tripId + '_expenses');
            unsubscribes.push(onSnapshot(expensesCol, (snap) => {
                if (!auth.currentUser) return;
                state.expenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAll();
            }));
        };

        window.startNewTrip = async () => {
            if (!auth.currentUser) return showMessage("請先等待連線完成");
            const newTripId = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tripMetadata', newTripId), { 
                    campName: state.campName,
                    campFee: state.campFee,
                    nightFee: state.nightFee,
                    campDetails: state.campDetails
                });
                
                const memberColRef = collection(db, 'artifacts', appId, 'public', 'data', newTripId + '_members');
                for (let m of state.members) await addDoc(memberColRef, { name: m.name });
                
                const expenseColRef = collection(db, 'artifacts', appId, 'public', 'data', newTripId + '_expenses');
                for (let e of state.expenses) await addDoc(expenseColRef, { 
                    title: e.title, amount: e.amount, payerName: e.payerName, date: e.date, id: Date.now() 
                });

                startRealtimeSync(newTripId);
                toggleSyncModal();
                showMessage("多人同步已開啟！");
            } catch (err) {
                showMessage("開啟同步失敗");
            }
        };

        window.joinExistingTrip = async () => {
            if (!auth.currentUser) return;
            const inputId = document.getElementById('join-trip-id').value.trim().toUpperCase();
            if (!inputId) return;
            const check = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tripMetadata', inputId));
            if (check.exists()) {
                startRealtimeSync(inputId);
                toggleSyncModal();
                showMessage("已成功加入行程");
            } else showMessage("找不到此行程 ID");
        };

        window.stopSync = () => {
            state.isSyncing = false;
            state.tripId = null;
            localStorage.removeItem('active_trip_id');
            unsubscribes.forEach(u => u());
            updateSyncUI(false);
            loadLocalData();
        };

        // --- Data Logic ---
        function loadLocalData() {
            state.members = JSON.parse(localStorage.getItem('camp_members')) || [];
            state.expenses = JSON.parse(localStorage.getItem('camp_expenses')) || [];
            state.campName = localStorage.getItem('camp_name') || "";
            state.campFee = parseFloat(localStorage.getItem('camp_fee')) || 0;
            state.nightFee = parseFloat(localStorage.getItem('night_fee')) || 0;
            state.campDetails = localStorage.getItem('camp_details') || "";
            syncFormFields();
            renderAll();
            updateLocationUI();
        }

        function syncFormFields() {
            const nameIn = document.getElementById('manual-location');
            const feeIn = document.getElementById('camp-fee-input');
            const nFeeIn = document.getElementById('night-fee-input');
            const detIn = document.getElementById('camp-details-input');
            if(nameIn) nameIn.value = state.campName;
            if(feeIn) feeIn.value = state.campFee || "";
            if(nFeeIn) nFeeIn.value = state.nightFee || "";
            if(detIn) detIn.value = state.campDetails;
        }

        window.saveTripData = async () => {
            const name = document.getElementById('manual-location').value.trim();
            const fee = parseFloat(document.getElementById('camp-fee-input').value) || 0;
            const nFee = parseFloat(document.getElementById('night-fee-input').value) || 0;
            const det = document.getElementById('camp-details-input').value;

            if (!name) return showMessage("請輸入營地名稱");

            const update = { campName: name, campFee: fee, nightFee: nFee, campDetails: det };

            if (state.isSyncing && auth.currentUser) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tripMetadata', state.tripId), update);
            } else {
                state.campName = name; state.campFee = fee; state.nightFee = nFee; state.campDetails = det;
                localStorage.setItem('camp_name', name);
                localStorage.setItem('camp_fee', fee);
                localStorage.setItem('night_fee', nFee);
                localStorage.setItem('camp_details', det);
                renderDashboard();
                updateLocationUI();
            }
            showMessage("行程細節已儲存");
        };

        window.addMember = async () => {
            const input = document.getElementById('member-name');
            const name = input.value.trim();
            if (!name) return;
            if (state.members.find(m => m.name === name)) return showMessage("成員名字已存在");
            if (state.isSyncing && auth.currentUser) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', state.tripId + '_members'), { name });
            else { state.members.push({ id: Date.now().toString(), name }); saveLocal(); }
            input.value = "";
        };

        window.removeMember = async (id) => {
            const member = state.members.find(m => m.id == id);
            if (state.expenses.some(e => e.payerName == member?.name)) return showMessage("此成員已有支出紀錄");
            if (state.isSyncing && auth.currentUser) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', state.tripId + '_members', id));
            else { state.members = state.members.filter(m => m.id != id); saveLocal(); }
        };

        window.addExpense = async () => {
            if (state.members.length === 0) { showMessage("請先新增成員！"); switchTab('members-tab'); return; }
            const titleInput = document.getElementById('exp-title');
            const amountInput = document.getElementById('exp-amount');
            const payerId = document.getElementById('exp-payer').value;
            const title = titleInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const payer = state.members.find(m => m.id == payerId);
            if (!title || isNaN(amount) || amount <= 0 || !payer) return showMessage("請填寫完整資訊");
            if (state.members.length < 2) return showMessage("至少需要兩名成員");

            const expense = { title, amount, payerName: payer.name, date: new Date().toLocaleDateString(), id: Date.now() };
            if (state.isSyncing && auth.currentUser) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', state.tripId + '_expenses'), expense);
            else { state.expenses.push(expense); saveLocal(); }
            titleInput.value = ""; amountInput.value = "";
            showMessage("支出已新增");
        };

        window.removeExpense = async (id) => {
            if (state.isSyncing && auth.currentUser) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', state.tripId + '_expenses', id));
            else { state.expenses = state.expenses.filter(e => e.id != id); saveLocal(); }
        };

        function saveLocal() {
            localStorage.setItem('camp_members', JSON.stringify(state.members));
            localStorage.setItem('camp_expenses', JSON.stringify(state.expenses));
            renderAll();
        }

        function calculateSettlement() {
            if (state.members.length < 2) return [];
            const total = state.expenses.reduce((sum, e) => sum + e.amount, 0);
            const perPerson = total / state.members.length;
            let balances = state.members.map(m => ({ name: m.name, balance: state.expenses.filter(e => e.payerName == m.name).reduce((sum,e)=>sum+e.amount,0) - perPerson }));
            let creditors = balances.filter(b => b.balance > 0).sort((a,b)=>b.balance-a.balance);
            let debtors = balances.filter(b => b.balance < 0).sort((a,b)=>a.balance-b.balance);
            let tx = []; let i=0, j=0;
            while(i<debtors.length && j<creditors.length) {
                let amt = Math.min(-debtors[i].balance, creditors[j].balance);
                if(amt > 0.01) tx.push({ from: debtors[i].name, to: creditors[j].name, amount: amt.toFixed(0) });
                debtors[i].balance += amt; creditors[j].balance -= amt;
                if(Math.abs(debtors[i].balance)<0.01) i++; if(Math.abs(creditors[j].balance)<0.01) j++;
            }
            return tx;
        }

        // --- UI Rendering ---
        window.renderAll = () => {
            renderDashboard();
            const memberBody = document.getElementById('members-list-body');
            if (memberBody) {
                memberBody.innerHTML = state.members.map(m => {
                    const paid = state.expenses.filter(e => e.payerName == m.name).reduce((sum, e) => sum + e.amount, 0);
                    return `<tr class="border-b border-stone-100"><td class="px-6 py-4 font-medium">${m.name}</td><td class="px-6 py-4 text-right text-emerald-600 font-bold">$${paid.toLocaleString()}</td><td class="px-6 py-4 text-right"><button onclick="removeMember('${m.id}')" class="text-rose-500 hover:text-rose-700 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`;
                }).join('') || '<tr><td colspan="3" class="px-6 py-8 text-center text-stone-400 italic">尚無成員</td></tr>';
            }
            const payerSelect = document.getElementById('exp-payer');
            if (payerSelect) {
                payerSelect.innerHTML = state.members.length === 0 ? '<option value="">請先新增成員</option>' : state.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                state.members.length === 0 ? payerSelect.classList.add('italic', 'text-stone-400') : payerSelect.classList.remove('italic', 'text-stone-400');
            }
            const expenseList = document.getElementById('expense-list');
            if (expenseList) {
                expenseList.innerHTML = state.expenses.length === 0 ? `<div class="bg-white p-8 rounded-xl border border-dashed border-stone-300 text-center text-stone-400">尚無支出記錄</div>` : state.expenses.slice().sort((a,b)=>b.id-a.id).map(e => `
                    <div class="expense-card bg-white p-4 rounded-xl shadow-sm border border-stone-100 flex justify-between items-center">
                        <div><h4 class="font-bold text-stone-800">${e.title}</h4><p class="text-xs text-stone-500">${e.date} • ${e.payerName || '未知'} 支付</p></div>
                        <div class="flex items-center gap-4"><span class="text-lg font-bold text-emerald-600">$${e.amount.toLocaleString()}</span><button onclick="removeExpense('${e.id}')" class="text-stone-300 hover:text-rose-500 transition"><i data-lucide="x-circle" class="w-5 h-5"></i></button></div>
                    </div>`).join('');
            }
            lucide.createIcons();
        };

        window.renderDashboard = () => {
            const expTotal = state.expenses.reduce((sum, e) => sum + e.amount, 0);
            const campTotal = (state.campFee || 0) + (state.nightFee || 0);
            const avg = state.members.length > 0 ? Math.round(expTotal / state.members.length) : 0;
            
            const el = (id) => document.getElementById(id);
            if (el('dash-camp-name')) el('dash-camp-name').innerText = state.campName || "尚未設定目的地";
            if (el('dash-total-expense')) el('dash-total-expense').innerText = `$${expTotal.toLocaleString()}`;
            if (el('dash-avg-expense')) el('dash-avg-expense').innerText = `$${avg.toLocaleString()}`;
            if (el('dash-camp-fee-total')) el('dash-camp-fee-total').innerText = `$${campTotal.toLocaleString()}`;
            if (el('dash-member-count')) el('dash-member-count').innerText = `${state.members.length} 人`;
            if (el('dash-expense-count')) el('dash-expense-count').innerText = `${state.expenses.length} 筆`;
            if (el('header-camp-name')) el('header-camp-name').innerText = state.campName || "尚未設定行程";
            if (el('dash-location-btn-container')) state.campName ? el('dash-location-btn-container').classList.remove('hidden') : el('dash-location-btn-container').classList.add('hidden');

            const detailsCard = el('dash-trip-details-card');
            const detailsContent = el('dash-camp-details-content');
            if (detailsCard && detailsContent) {
                if (state.campFee > 0 || state.nightFee > 0 || state.campDetails) {
                    detailsCard.classList.remove('hidden');
                    let html = '';
                    if (state.campFee > 0) html += `<div class="flex justify-between"><span>營位費：</span><span class="font-bold">$${state.campFee.toLocaleString()}</span></div>`;
                    if (state.nightFee > 0) html += `<div class="flex justify-between"><span>夜衝費：</span><span class="font-bold">$${state.nightFee.toLocaleString()}</span></div>`;
                    if (state.campDetails) html += `<div class="mt-2 pt-2 border-t border-stone-100 italic text-stone-400">備註：${state.campDetails}</div>`;
                    detailsContent.innerHTML = html;
                } else detailsCard.classList.add('hidden');
            }

            const dashSettle = el('dash-settlement-list');
            if (dashSettle) {
                const tx = calculateSettlement();
                dashSettle.innerHTML = tx.length > 0 ? tx.map(t => `<div class="flex items-center justify-between bg-emerald-50/50 p-2 rounded-lg border border-emerald-100 text-sm"><span><b>${t.from}</b> <i data-lucide="arrow-right" class="inline w-3 h-3 text-stone-400"></i> <b>${t.to}</b></span><span class="font-bold text-emerald-700">$${parseInt(t.amount).toLocaleString()}</span></div>`).join('') : '<p class="text-center text-stone-400 py-4 text-sm italic">尚與分帳建議</p>';
            }

            const ranking = el('dash-payer-ranking');
            if (ranking) {
                if (state.members.length > 0) {
                    const data = state.members.map(m => ({ name: m.name, paid: state.expenses.filter(e => e.payerName == m.name).reduce((sum, e) => sum + e.amount, 0) })).sort((a,b)=>b.paid-a.paid);
                    const max = Math.max(...data.map(p => p.paid), 1);
                    ranking.innerHTML = data.map(p => `<div class="space-y-1"><div class="flex justify-between text-xs font-medium"><span>${p.name}</span><span>$${p.paid.toLocaleString()}</span></div><div class="w-full bg-stone-100 rounded-full h-2 overflow-hidden"><div class="bg-emerald-500 h-full rounded-full transition-all duration-500" style="width: ${Math.round((p.paid/max)*100)}%"></div></div></div>`).join('');
                } else ranking.innerHTML = '<p class="text-center text-stone-400 py-2 text-xs">暫無數據</p>';
            }
            lucide.createIcons();
        }

        window.updateLocationUI = () => {
            const activeUi = document.getElementById('location-active-ui');
            const display = document.getElementById('display-camp-name');
            if (state.campName && display && activeUi) { activeUi.classList.remove('hidden'); display.innerText = state.campName; }
            else if (activeUi) activeUi.classList.add('hidden');
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(tabId);
            if (target) target.classList.remove('hidden');
            ['dashboard-tab', 'map-tab', 'expense-tab', 'members-tab'].forEach(id => {
                const btn = document.getElementById(`btn-${id}`);
                if (btn) btn.className = `flex-1 min-w-[80px] py-3 text-center font-medium ${id === tabId ? 'tab-active' : 'text-stone-500'} transition-all`;
            });
            lucide.createIcons();
        };

        window.toggleSyncModal = () => document.getElementById('sync-modal')?.classList.toggle('hidden');
        window.showMessage = (text) => {
            const box = document.getElementById('message-box');
            const msg = document.getElementById('message-text');
            if (!box || !msg) return;
            msg.innerText = text;
            box.style.opacity = '1'; box.style.transform = 'translate(-50%, -10px)';
            setTimeout(() => { box.style.opacity = '0'; box.style.transform = 'translate(-50%, 0px)'; }, 2500);
        };
        window.copyTripID = () => {
            const el = document.createElement('textarea');
            el.value = state.tripId;
            document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            showMessage("行程 ID 已複製！");
        };
        window.openGoogleMaps = () => { if (state.campName) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(state.campName)}`, '_blank'); };

        initAuth();
    </script>
</body>
</html>
