<!-- 
    專案：露營小助手 (Camping Assistant)
    版本：v1.2.2
    描述：穩定部署版，徹底解決日期欄位寬度與高度不一致問題，維持所有既有邏輯（筆劃排序、雲端刪除修復、備註展開）。
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>露營小助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        * { box-sizing: border-box; } /* 確保 Padding 不會撐開寬度 */

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f8faf8; 
            -webkit-tap-highlight-color: transparent;
        }

        .tab-active { 
            border-bottom: 3px solid #059669; 
            color: #059669; 
        }

        .expense-card { transition: transform 0.2s; position: relative; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 隱藏數字輸入框箭頭 */
        input::-webkit-outer-spin-button, 
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* 核心：高度與格式統一的輸入框樣式 */
        .uniform-input { 
            display: block;
            width: 100%; 
            height: 3rem; /* 強制所有欄位高度相同 */
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #1c1917;
            background-color: #ffffff;
            border: 1px solid #e5e7eb; 
            border-radius: 0.5rem; 
            outline: none; 
            transition: all 0.2s;
            appearance: none;
            -webkit-appearance: none;
        }

        .uniform-input:focus { 
            border-color: #059669; 
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.2); 
        }

        /* 確保日期輸入框在不同平台的表現一致 */
        input[type="date"].uniform-input {
            min-height: 3rem;
            display: flex;
            align-items: center;
        }

        /* 針對 select 的選單箭頭優化 */
        select.uniform-input {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="text-stone-800">

    <!-- Header -->
    <header class="bg-emerald-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2"><i data-lucide="layout-dashboard"></i> 露營小助手</h1>
            <div class="flex items-center gap-2">
                <button onclick="window.toggleSyncModal()" id="sync-status-btn" class="text-xs bg-emerald-800 hover:bg-emerald-900 px-3 py-1 rounded-full flex items-center gap-1 transition border border-emerald-600/30">
                    <span id="sync-dot" class="w-2 h-2 bg-stone-400 rounded-full"></span>
                    <span id="sync-text">連線準備中...</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b border-stone-200 sticky top-[60px] z-40">
        <div class="max-w-4xl mx-auto flex overflow-x-auto no-scrollbar">
            <button onclick="window.switchTab('dashboard-tab')" id="btn-dashboard-tab" class="flex-1 min-w-[80px] py-3 text-center font-medium tab-active transition-all">總覽</button>
            <button onclick="window.switchTab('map-tab')" id="btn-map-tab" class="flex-1 min-w-[80px] py-3 text-center font-medium text-stone-500 transition-all">行程</button>
            <button onclick="window.switchTab('expense-tab')" id="btn-expense-tab" class="flex-1 min-w-[80px] py-3 text-center font-medium text-stone-500 transition-all">分帳</button>
            <button onclick="window.switchTab('members-tab')" id="btn-members-tab" class="flex-1 min-w-[80px] py-3 text-center font-medium text-stone-500 transition-all">成員</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 pb-24">
        <!-- Dashboard Tab -->
        <section id="dashboard-tab" class="space-y-4">
            <div class="bg-gradient-to-br from-emerald-600 to-teal-700 rounded-2xl px-6 py-[22px] text-white shadow-lg">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="dash-camp-name" class="text-2xl font-bold text-white whitespace-pre-line leading-tight">尚未設定日期\n\n尚未設定目的地</h2>
                    <i data-lucide="tent" class="w-10 h-10 opacity-30 text-white"></i>
                </div>
                <div id="dash-location-btn-container" class="hidden text-right">
                    <button onclick="window.openGoogleMaps()" class="bg-white/20 hover:bg-white/30 transition px-4 py-2 rounded-lg text-sm flex items-center gap-2 inline-flex text-white">
                        <i data-lucide="map" class="w-4 h-4"></i> 開啟導航
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100">
                    <p class="text-[10px] text-stone-400 font-bold mb-1 uppercase tracking-wider text-center">分帳支出總額</p>
                    <p id="dash-total-expense" class="text-xl font-bold text-emerald-700">$0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100">
                    <p class="text-[10px] text-stone-400 font-bold mb-1 uppercase tracking-wider text-center">每人分擔</p>
                    <p id="dash-avg-expense" class="text-xl font-bold text-blue-600">$0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100">
                    <p class="text-[10px] text-stone-400 font-bold mb-1 uppercase tracking-wider text-center">預估費用(每帳)</p>
                    <p id="dash-camp-fee-total" class="text-xl font-bold text-amber-600">$0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100">
                    <p class="text-[10px] text-stone-400 font-bold mb-1 uppercase tracking-wider text-center">成員人數</p>
                    <p id="dash-member-count" class="text-xl font-bold text-stone-700">0 人</p>
                </div>
            </div>

            <div id="dash-trip-details-card" class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100 hidden text-sm">
                <h3 class="font-bold text-stone-600 mb-3 flex items-center gap-2"><i data-lucide="clipboard-list" class="w-4 h-4 text-emerald-600"></i> 行程詳情</h3>
                <div id="dash-camp-details-content" class="space-y-2 text-stone-700 font-normal"></div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-stone-100 overflow-hidden">
                <div class="bg-stone-50 px-4 py-3 border-b border-stone-100 flex items-center gap-2">
                    <i data-lucide="calculator" class="w-4 h-4 text-emerald-600"></i>
                    <h3 class="font-bold text-sm">結算分帳明細</h3>
                </div>
                <div id="dash-settlement-list" class="p-4 space-y-3 text-sm"></div>
            </div>
            
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                <h3 class="font-bold mb-3 text-sm text-stone-600 flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4 text-emerald-600"></i> 支出總覽</h3>
                <div id="dash-payer-ranking" class="space-y-3"></div>
            </div>
        </section>

        <!-- Trip Settings Tab -->
        <section id="map-tab" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                <h3 class="font-bold mb-4 text-emerald-700 flex items-center gap-2"><i data-lucide="map-pin"></i> 營地資訊設定</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="block text-xs font-bold text-stone-400 uppercase">營地名稱</label>
                            <input type="text" id="manual-location" onkeyup="if(event.key==='Enter') window.saveTripData()" placeholder="例如：武陵農場..." class="uniform-input">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-xs font-bold text-stone-400 uppercase">行程日期</label>
                            <input type="date" id="camp-date-input" onkeyup="if(event.key==='Enter') window.saveTripData()" class="uniform-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label class="block text-xs font-bold text-stone-400 uppercase">營位費(每帳)</label>
                            <input type="number" id="camp-fee-input" onkeyup="if(event.key==='Enter') window.saveTripData()" placeholder="0" class="uniform-input">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-xs font-bold text-stone-400 uppercase">夜衝費(每帳)</label>
                            <input type="number" id="night-fee-input" onkeyup="if(event.key==='Enter') window.saveTripData()" placeholder="0" class="uniform-input">
                        </div>
                        <div class="col-span-2 md:col-span-1 space-y-1">
                            <label class="block text-xs font-bold text-stone-400 uppercase">手續費(每帳)</label>
                            <input type="number" id="proc-fee-input" onkeyup="if(event.key==='Enter') window.saveTripData()" placeholder="0" class="uniform-input">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-xs font-bold text-stone-400 uppercase">行程備註</label>
                        <textarea id="camp-details-input" rows="3" placeholder="例如：預計 14:00 入場、營位 A1..." class="w-full border p-3 rounded-lg outline-none uniform-input !h-auto min-h-[120px]"></textarea>
                    </div>
                    <button onclick="window.saveTripData()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-md active:scale-[0.98] transition">儲存行程資料</button>
                    <div id="location-active-ui" class="hidden text-center mt-2">
                        <button onclick="window.openGoogleMaps()" class="text-emerald-700 font-bold underline flex items-center justify-center gap-1 mx-auto text-sm"><i data-lucide="external-link" class="w-4 h-4"></i> 在 Google Map 中開啟搜尋</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Expenses Tab -->
        <section id="expense-tab" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                <h3 class="font-bold mb-4 text-emerald-700 flex items-center gap-2"><i data-lucide="plus-circle"></i> 新增支出項目</h3>
                <!-- 修正點：所有欄位套用統一的高度與樣式控管 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider">支出項目</label>
                        <input type="text" id="exp-title" onkeyup="if(event.key==='Enter') document.getElementById('exp-amount').focus()" placeholder="例如：全聯買菜" class="uniform-input">
                    </div>
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider">金額</label>
                        <input type="number" id="exp-amount" onkeyup="if(event.key==='Enter') window.addExpense()" placeholder="0" class="uniform-input">
                    </div>
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider">日期</label>
                        <input type="date" id="exp-date" class="uniform-input">
                    </div>
                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-stone-400 uppercase tracking-wider">付款人</label>
                        <select id="exp-payer" class="uniform-input"></select>
                    </div>
                    <div class="md:col-span-2">
                        <button onclick="window.addExpense()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl mt-2 shadow-sm active:scale-[0.98] transition">新增紀錄</button>
                    </div>
                </div>
            </div>
            <div id="expense-list" class="space-y-3 text-center"></div>
        </section>

        <!-- Members Tab -->
        <section id="members-tab" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 flex gap-2">
                <input type="text" id="member-name" onkeyup="if(event.key==='Enter') window.addMember()" placeholder="輸入露友名字..." class="flex-1 border p-3 rounded-lg uniform-input">
                <button onclick="window.addMember()" class="bg-emerald-600 text-white px-6 rounded-lg font-bold shadow-sm active:scale-95">新增</button>
            </div>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-stone-100">
                <table class="w-full text-left text-sm">
                    <thead class="bg-stone-50 border-b font-bold text-xs text-stone-500 uppercase"><tr><th class="p-4">成員</th><th class="p-4 text-right">已墊付總額</th><th class="p-4 text-right">操作</th></tr></thead>
                    <tbody id="members-list-body"></tbody>
                </table>
            </div>
            <div class="pt-6 border-t border-stone-200">
                <button onclick="window.resetAllLocalData()" class="text-xs text-rose-400 mx-auto block hover:underline">清空本地快取資料 (重新開始)</button>
            </div>
        </section>
    </main>

    <!-- Sync Modal -->
    <div id="sync-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 space-y-6 shadow-2xl">
            <div class="flex justify-between items-center"><h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="refresh-cw" class="text-emerald-600"></i> 多人連線同步</h2><button onclick="window.toggleSyncModal()" class="p-1"><i data-lucide="x"></i></button></div>
            <div id="sync-off-ui" class="space-y-4">
                <p class="text-sm text-stone-500 text-center leading-relaxed">將目前已輸入的資料同步至雲端，產生的 ID 即可分享給露友即時編輯。</p>
                <button onclick="window.startNewTrip()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-md flex items-center justify-center gap-2 active:scale-[0.98]"><i data-lucide="cloud-upload"></i> 同步資料</button>
                <div class="relative flex items-center py-2"><div class="flex-grow border-t border-stone-200"></div><span class="flex-shrink mx-4 text-stone-400 text-[10px] font-bold uppercase tracking-widest text-center">或者加入現有行程</span><div class="flex-grow border-t border-stone-200"></div></div>
                <div class="flex flex-row items-center gap-2 w-full mt-2">
                    <input type="text" id="join-trip-id" onkeyup="if(event.key==='Enter') window.joinExistingTrip()" placeholder="輸入行程 ID" class="flex-1 uniform-input uppercase font-mono">
                    <button onclick="window.joinExistingTrip()" class="bg-stone-800 text-white px-5 py-3 rounded-lg font-bold shadow-md active:scale-95">加入</button>
                </div>
            </div>
            <div id="sync-on-ui" class="hidden text-center space-y-4">
                <div class="bg-emerald-50 p-6 rounded-2xl border border-emerald-100 shadow-inner">
                    <p class="text-[10px] text-emerald-600 mb-2 font-bold tracking-widest uppercase">當前連線行程 ID</p>
                    <div class="flex items-center justify-center gap-3">
                        <code id="current-trip-id-display" class="text-3xl font-mono font-bold text-emerald-800 tracking-wider">------</code>
                        <button onclick="window.copyTripID()" class="p-2 bg-white rounded-lg shadow-sm active:scale-90 transition"><i data-lucide="copy" class="text-emerald-600"></i></button>
                    </div>
                </div>
                <button onclick="window.stopSync()" class="w-full border border-stone-200 py-3 rounded-xl text-stone-500 text-sm hover:bg-stone-50 transition">停止同步並返回單機模式</button>
                <button onclick="window.clearCloudData()" class="w-full text-rose-400 text-xs mt-4 hover:underline transition">清空此行程在雲端的所有資料</button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-stone-800 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 pointer-events-none transition-all z-[100] text-sm"><span id="message-text"></span></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVH1K1ySFPAhciZ-U2ByF88A_Uc55J1mc",
            authDomain: "campingapp-fc3b3.firebaseapp.com",
            projectId: "campingapp-fc3b3",
            storageBucket: "campingapp-fc3b3.firebasestorage.app",
            messagingSenderId: "1032462785908",
            appId: "1:1032462785908:web:4feea04326a4e8c6e26021"
        };

        const appId = 'camp-v1';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = { 
            isSyncing: false, tripId: localStorage.getItem('active_trip_id') || null, 
            user: null, members: [], expenses: [], 
            campName: "", campDate: "", campFee: 0, nightFee: 0, procFee: 0, campDetails: "",
            detailsExpanded: false
        };
        let unsubscribes = [];

        window.toggleSyncModal = () => document.getElementById('sync-modal')?.classList.toggle('hidden');
        window.toggleDetails = () => { state.detailsExpanded = !state.detailsExpanded; window.renderDashboard(); };
        
        window.switchTab = (tabId) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(tabId)?.classList.remove('hidden');
            ['dashboard-tab', 'map-tab', 'expense-tab', 'members-tab'].forEach(id => {
                const btn = document.getElementById(`btn-${id}`);
                if (btn) btn.className = `flex-1 min-w-[80px] py-3 text-center font-medium ${id === tabId ? 'tab-active' : 'text-stone-500'} transition-all`;
            });
            if (tabId === 'map-tab') syncFormFields();
            lucide.createIcons();
        };

        window.showMessage = (text) => {
            const box = document.getElementById('message-box');
            document.getElementById('message-text').innerText = text;
            box.style.opacity = '1'; setTimeout(() => box.style.opacity = '0', 2500);
        };

        const updateSyncUI = (active) => {
            const dot = document.getElementById('sync-dot');
            const txt = document.getElementById('sync-text');
            const off = document.getElementById('sync-off-ui');
            const on = document.getElementById('sync-on-ui');
            if (dot) dot.className = `w-2 h-2 rounded-full ${active ? 'bg-emerald-400 animate-pulse shadow-[0_0_8px_#34d399]' : 'bg-stone-400'}`;
            if (txt) txt.innerText = active ? `連線中 (${state.tripId})` : (auth.currentUser ? "同步就緒" : "等待連線...");
            if (off) off.classList.toggle('hidden', active);
            if (on) on.classList.toggle('hidden', !active);
            if (active) document.getElementById('current-trip-id-display').innerText = state.tripId;
        };

        const startRealtimeSync = async (tripId) => {
            if (!tripId || !auth.currentUser) return;
            unsubscribes.forEach(u => u()); unsubscribes = [];
            state.isSyncing = true; state.tripId = tripId;
            localStorage.setItem('active_trip_id', tripId);
            updateSyncUI(true);

            unsubscribes.push(onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'meta', tripId), (snap) => {
                if (snap.exists()) {
                    const d = snap.data();
                    state.campName = d.campName || ""; state.campDate = d.campDate || "";
                    state.campFee = d.campFee || 0; state.nightFee = d.nightFee || 0; state.procFee = d.procFee || 0;
                    state.campDetails = d.campDetails || "";
                    syncFormFields(); renderAll(); 
                }
            }));

            unsubscribes.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', tripId + '_m'), (snap) => {
                state.members = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderAll();
            }));

            unsubscribes.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', tripId + '_e'), (snap) => {
                state.expenses = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderAll();
            }));
        };

        window.startNewTrip = async () => {
            if (!auth.currentUser) return;
            const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'meta', newId), { 
                    campName: state.campName, campDate: state.campDate, campFee: state.campFee, nightFee: state.nightFee, procFee: state.procFee, campDetails: state.campDetails 
                });
                for (let m of state.members) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', newId + '_m', String(m.id)), { name: m.name, id: m.id });
                }
                for (let e of state.expenses) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', newId + '_e', String(e.id)), { 
                        title: e.title, amount: e.amount, payerName: e.payerName, date: e.date, id: e.id 
                    });
                }
                startRealtimeSync(newId); window.toggleSyncModal(); window.showMessage("雲端同步已開啟");
            } catch (e) { window.showMessage("同步失敗"); }
        };

        window.joinExistingTrip = async () => {
            const id = document.getElementById('join-trip-id').value.trim().toUpperCase();
            if (!id) return;
            const check = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'meta', id));
            if (check.exists()) { startRealtimeSync(id); window.toggleSyncModal(); window.showMessage("成功加入行程"); }
            else window.showMessage("行程 ID 找不到");
        };

        window.stopSync = () => { unsubscribes.forEach(u => u()); state.isSyncing = false; state.tripId = null; localStorage.removeItem('active_trip_id'); updateSyncUI(false); loadLocalData(); window.showMessage("已返回單機模式"); };

        window.clearCloudData = async () => {
            if (!state.isSyncing || !state.tripId || !confirm("確定要清空雲端上的所有紀錄（支出與成員）嗎？")) return;
            try {
                const eDocs = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', state.tripId + '_e'));
                for (let d of eDocs.docs) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', state.tripId + '_e', d.id));
                const mDocs = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', state.tripId + '_m'));
                for (let d of mDocs.docs) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', state.tripId + '_m', d.id));
                window.showMessage("雲端資料已清空");
            } catch (e) { window.showMessage("清空失敗"); }
        };

        window.saveTripData = async () => {
            const name = document.getElementById('manual-location').value.trim();
            const date = document.getElementById('camp-date-input').value;
            const fee = parseFloat(document.getElementById('camp-fee-input').value) || 0;
            const nFee = parseFloat(document.getElementById('night-fee-input').value) || 0;
            const pFee = parseFloat(document.getElementById('proc-fee-input').value) || 0;
            const det = document.getElementById('camp-details-input').value;
            if (!name) return window.showMessage("請輸入營地名稱");
            if (state.isSyncing) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'meta', state.tripId), { campName: name, campDate: date, campFee: fee, nightFee: nFee, procFee: pFee, campDetails: det }, { merge: true });
            } else {
                state.campName = name; state.campDate = date; state.campFee = fee; state.nightFee = nFee; state.procFee = pFee; state.campDetails = det;
                localStorage.setItem('camp_name', name); localStorage.setItem('camp_date', date); localStorage.setItem('camp_fee', fee); localStorage.setItem('night_fee', nFee); localStorage.setItem('proc_fee', pFee); localStorage.setItem('camp_details', det);
                renderAll();
            }
            window.showMessage("行程資料已更新");
        };

        window.addMember = async () => {
            const name = document.getElementById('member-name').value.trim();
            if (!name) return;
            const newId = Date.now();
            if (state.isSyncing) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', state.tripId + '_m', String(newId)), { name, id: newId });
            else { state.members.push({ id: newId, name }); saveLocal(); }
            document.getElementById('member-name').value = "";
        };

        window.removeMember = async (id) => {
            const m = state.members.find(x => x.id == id);
            if (state.expenses.some(e => e.payerName == m?.name)) return window.showMessage("此人已有支出不可刪除");
            if (state.isSyncing) {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', state.tripId + '_m', String(id))); } catch (e) { window.showMessage("刪除失敗"); }
            } else { state.members = state.members.filter(x => x.id != id); saveLocal(); }
        };

        window.addExpense = async () => {
            const title = document.getElementById('exp-title').value.trim();
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const date = document.getElementById('exp-date').value;
            const payerId = document.getElementById('exp-payer').value;
            const payer = state.members.find(m => m.id == payerId);
            if (!title || isNaN(amount) || amount <= 0 || !payer) return window.showMessage("請檢查輸入欄位");
            const newId = Date.now();
            if (state.isSyncing) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', state.tripId + '_e', String(newId)), { title, amount, payerName: payer.name, date, id: newId });
            } else { 
                state.expenses.push({ id: newId, title, amount, payerName: payer.name, date }); saveLocal(); 
            }
            document.getElementById('exp-title').value = ""; document.getElementById('exp-amount').value = ""; document.getElementById('exp-title').focus();
            window.showMessage(`已紀錄: ${title}`);
        };

        window.removeExpense = async (id) => {
            if (state.isSyncing) {
                try {
                    state.expenses = state.expenses.filter(e => String(e.id) !== String(id));
                    renderAll();
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', state.tripId + '_e', String(id)));
                    window.showMessage("紀錄已刪除");
                } catch (e) { window.showMessage("刪除失敗"); }
            } else {
                state.expenses = state.expenses.filter(e => e.id != id);
                saveLocal();
            }
        };

        function saveLocal() { localStorage.setItem('camp_members', JSON.stringify(state.members)); localStorage.setItem('camp_expenses', JSON.stringify(state.expenses)); renderAll(); }
        
        function loadLocalData() { 
            state.members = JSON.parse(localStorage.getItem('camp_members')) || []; 
            state.expenses = JSON.parse(localStorage.getItem('camp_expenses')) || []; 
            state.campName = localStorage.getItem('camp_name') || ""; 
            state.campDate = localStorage.getItem('camp_date') || ""; 
            state.campFee = parseFloat(localStorage.getItem('camp_fee')) || 0; 
            state.nightFee = parseFloat(localStorage.getItem('night_fee')) || 0; 
            state.procFee = parseFloat(localStorage.getItem('proc_fee')) || 0; 
            state.campDetails = localStorage.getItem('camp_details') || ""; 
            
            const expDateInput = document.getElementById('exp-date');
            if (expDateInput) expDateInput.value = new Date().toISOString().split('T')[0];
            
            syncFormFields(); renderAll(); 
        }

        function syncFormFields() { 
            const el = (id) => document.getElementById(id); 
            if (el('manual-location')) el('manual-location').value = state.campName; 
            if (el('camp-date-input')) el('camp-date-input').value = state.campDate; 
            if (el('camp-fee-input')) el('camp-fee-input').value = state.campFee === 0 ? "0" : (state.campFee || ""); 
            if (el('night-fee-input')) el('night-fee-input').value = state.nightFee === 0 ? "0" : (state.nightFee || ""); 
            if (el('proc-fee-input')) el('proc-fee-input').value = state.procFee === 0 ? "0" : (state.procFee || ""); 
            if (el('camp-details-input')) el('camp-details-input').value = state.campDetails; 
        }

        function calculateSettlement() {
            if (state.members.length < 2) return [];
            const total = state.expenses.reduce((sum, e) => sum + e.amount, 0);
            const perPerson = total / state.members.length;
            let balances = state.members.map(m => ({ name: m.name, balance: (state.expenses.filter(e => e.payerName == m.name).reduce((sum, e) => sum + e.amount, 0)) - perPerson }));
            let creditors = balances.filter(b => b.balance > 0).sort((a,b)=>b.balance-a.balance);
            let debtors = balances.filter(b => b.balance < 0).sort((a,b)=>a.balance-b.balance);
            let tx = []; let i=0, j=0;
            while(i<debtors.length && j<creditors.length) {
                let amt = Math.min(-debtors[i].balance, creditors[j].balance);
                tx.push({ from: debtors[i].name, to: creditors[j].name, amount: amt.toFixed(0) });
                debtors[i].balance += amt; creditors[j].balance -= amt;
                if(Math.abs(debtors[i].balance)<0.01) i++; if(Math.abs(creditors[j].balance)<0.01) j++;
            }
            return tx.sort((a, b) => a.from.localeCompare(b.from, 'zh-Hant-TW'));
        }

        window.renderAll = () => {
            window.renderDashboard();
            const sortedM = [...state.members].sort((a,b)=>a.name.localeCompare(b.name, 'zh-Hant-TW'));
            document.getElementById('members-list-body').innerHTML = sortedM.map(m => {
                const paid = state.expenses.filter(e => e.payerName == m.name).reduce((sum, e) => sum + e.amount, 0);
                return `<tr class="border-b border-stone-100 transition hover:bg-stone-50"><td class="p-4 font-medium">${m.name}</td><td class="p-4 text-right text-emerald-600 font-bold">$${paid.toLocaleString()}</td><td class="p-4 text-right"><button onclick="window.removeMember('${m.id}')" class="text-rose-400 p-2 active:scale-90 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`;
            }).join('') || '<tr><td colspan="3" class="p-8 text-center text-stone-300 italic text-sm">尚未加入成員</td></tr>';
            
            const pSel = document.getElementById('exp-payer');
            if (pSel) {
                const cur = pSel.value;
                pSel.innerHTML = state.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                if (cur && state.members.some(m => String(m.id) === String(cur))) pSel.value = cur;
            }
            
            document.getElementById('expense-list').innerHTML = state.expenses.slice().sort((a,b)=>String(b.id).localeCompare(String(a.id))).map(e => `
                <div class="expense-card bg-white p-4 rounded-xl border border-stone-100 flex justify-between items-center shadow-sm">
                    <div class="flex-1 pr-8"><h4 class="font-bold text-stone-700 text-sm md:text-base">${e.title}</h4><p class="text-[10px] text-stone-400 font-bold uppercase tracking-tight">${e.date} • ${e.payerName} 付</p></div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-emerald-600 text-lg">$${e.amount.toLocaleString()}</span>
                        <button type="button" onclick="window.removeExpense('${e.id}')" class="p-2 -mr-1 text-stone-300 hover:text-rose-500 active:scale-75 transition duration-200"><i data-lucide="x-circle" class="w-6 h-6"></i></button>
                    </div>
                </div>`).join('') || '<div class="p-8 text-center text-stone-300 border border-dashed rounded-xl text-sm">暫無支出紀錄</div>';
            lucide.createIcons();
        };

        window.renderDashboard = () => {
            const el = (id) => document.getElementById(id);
            if (el('dash-camp-name')) el('dash-camp-name').innerHTML = `${state.campDate || "尚未設定日期"}\n\n${state.campName || "尚未設定目的地"}`;
            const expTotal = state.expenses.reduce((sum, e) => sum + e.amount, 0);
            if (el('dash-total-expense')) el('dash-total-expense').innerText = `$${expTotal.toLocaleString()}`;
            if (el('dash-avg-expense')) el('dash-avg-expense').innerText = `$${(state.members.length ? Math.round(expTotal / state.members.length) : 0).toLocaleString()}`;
            if (el('dash-camp-fee-total')) el('dash-camp-fee-total').innerText = `$${(state.campFee + state.nightFee + state.procFee).toLocaleString()}`;
            if (el('dash-member-count')) el('dash-member-count').innerText = `${state.members.length} 人`;
            
            const detailsCard = el('dash-trip-details-card');
            if (detailsCard) {
                if (state.campName || state.campDate || state.campFee > 0 || state.nightFee > 0 || state.procFee > 0 || state.campDetails) {
                    detailsCard.classList.remove('hidden');
                    let feeHtml = `<div class="flex justify-between items-center mb-1"><span>營位費(每帳)：</span><b>$${state.campFee.toLocaleString()}</b></div><div class="flex justify-between items-center mb-1"><span>夜衝費(每帳)：</span><b>$${state.nightFee.toLocaleString()}</b></div><div class="flex justify-between items-center mb-1"><span>手續費(每帳)：</span><b>$${state.procFee.toLocaleString()}</b></div>`;
                    let detHtml = '';
                    if (state.campDetails) {
                        const isLong = state.campDetails.split('\n').length > 3 || state.campDetails.length > 120;
                        detHtml = `<div class="mt-2 border-t pt-2 text-stone-500 text-xs font-normal"><div class="${state.detailsExpanded ? '' : 'line-clamp-3'} whitespace-pre-wrap">${state.campDetails}</div>${isLong ? `<button onclick="window.toggleDetails()" class="text-emerald-600 font-bold mt-1 hover:underline">${state.detailsExpanded ? '收起' : '... 更多'}</button>` : ''}</div>`;
                    }
                    el('dash-camp-details-content').innerHTML = feeHtml + detHtml;
                } else detailsCard.classList.add('hidden');
            }
            const dashSettle = el('dash-settlement-list');
            if (dashSettle) {
                const tx = calculateSettlement();
                dashSettle.innerHTML = tx.length ? tx.map(t => `<div class="flex justify-between bg-emerald-50/50 p-2 rounded-lg border border-emerald-100/30"><span><b>${t.from}</b> → <b>${t.to}</b></span><span class="font-bold text-emerald-700">$${parseInt(t.amount).toLocaleString()}</span></div>`).join('') : '<p class="text-center text-stone-300 py-4 italic text-sm">尚無分帳建議</p>';
            }
            const ranking = el('dash-payer-ranking');
            if (ranking) {
                if (state.members.length) {
                    const data = state.members.map(m => ({ name: m.name, paid: state.expenses.filter(e => e.payerName == m.name).reduce((sum, e) => sum + e.amount, 0) })).sort((a,b)=>a.name.localeCompare(b.name, 'zh-Hant-TW'));
                    const max = Math.max(...data.map(p => p.paid), 1);
                    ranking.innerHTML = data.map(p => `<div class="space-y-1 text-xs"><span>${p.name} ($${p.paid.toLocaleString()})</span><div class="w-full bg-stone-100 rounded-full h-1 shadow-inner"><div class="bg-emerald-500 h-full rounded-full transition-all duration-700" style="width: ${Math.min(100, Math.round((p.paid/max)*100))}%"></div></div></div>`).join('');
                } else ranking.innerHTML = '<p class="text-center text-stone-400 text-xs py-2 italic text-sm">暫無支出數據</p>';
            }
            lucide.createIcons();
        };

        window.openGoogleMaps = () => { if (state.campName) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(state.campName)}`, '_blank'); };
        window.copyTripID = () => { const el = document.createElement('textarea'); el.value = state.tripId; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); window.showMessage("ID 已複製到剪貼簿！"); };

        onAuthStateChanged(auth, (u) => { 
            state.user = u; 
            if (u && state.tripId) startRealtimeSync(state.tripId); 
            else { loadLocalData(); updateSyncUI(false); } 
        });

        const initAuth = async () => {
            try { await signInAnonymously(auth); } catch (e) { window.showMessage("伺服器連線失敗"); }
        };
        initAuth();
    </script>
</body>
</html>
